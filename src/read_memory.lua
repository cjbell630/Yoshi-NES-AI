---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by cb106.
--- DateTime: 2/11/2021 19:31
---

--REQUIRES--

require "util"

--END REQUIRES--


Blocks = {
    NONE = 0,
    GOOMBA = 1,
    PIRANHA = 2,
    BOO = 3,
    BLOOPER = 4,
    TOP_EGG = 5,
    BOTTOM_EGG = 6
}

local function readBytes(address, length)
    local bytes = {}
    for i = 0, length - 1, 1 do
        bytes[i + 1] = memory.readbyte(address + i)
    end
    return bytes
end



--BOARD ClASS--

Board = {}
Board.__index = Board
Board.raw = {
    --[[top   ->  bottom]] --
    { 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0 }
}

--TODO: this
function Board:getRow(rowNum)
    return {
        --Board.raw[1],
    }
end

--END BOARD CLASS--

--MEMMAP CLASS--

MemMap = {}
MemMap.__index = MemMap

--[[

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     address     â•‘        length       â•‘                                              explanation                                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ 0x0440          â•‘ 1 byte              â•‘ Represents mario's current position                                                                   â•‘
â•‘                 â•‘                     â•‘ 0, 1, or 2   ----   l -> r                                                                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ 0x0442          â•‘ 1 byte              â•‘ Represent's Mario's current animation frame.                                                          â•‘
â•‘                 â•‘                     â•‘ Cycles through whenever he turns, remains constant otherwise                                          â•‘
â•‘                 â•‘                     â•‘                                                                                                       â•‘
â•‘                 â•‘                     â•‘ 0 - forward                                                                                           â•‘
â•‘                 â•‘                     â•‘ 1/2/3 - turning                                                                                       â•‘
â•‘                 â•‘                     â•‘ 4 - backward                                                                                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ 0x045A          â•‘ 1 byte each         â•‘ Stores information about what types of blocks are currently falling                                   â•‘
â•‘ 0x045B          â•‘                     â•‘ (xxxA -> xxxD | l -> r column)                                                                        â•‘
â•‘ 0x045C          â•‘                     â•‘ Values are set the frame where the last group are set (which is one "tick" before they start falling) â•‘
â•‘ 0x045D          â•‘                     â•‘ Value is cleared when the block they represent is set/matched                                         â•‘
â•‘                 â•‘                     â•‘                                                                                                       â•‘
â•‘                 â•‘                     â•‘ 0 - empty                                                                                             â•‘
â•‘                 â•‘                     â•‘ 1 - Goomba                                                                                            â•‘
â•‘                 â•‘                     â•‘ 2 - Piranha Plant                                                                                     â•‘
â•‘                 â•‘                     â•‘ 3 - Boo                                                                                               â•‘
â•‘                 â•‘                     â•‘ 4 - Blooper                                                                                           â•‘
â•‘                 â•‘                     â•‘ 5 - Top Egg                                                                                           â•‘
â•‘                 â•‘                     â•‘ 6 - Bottom Egg                                                                                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ 0x0462          â•‘ 1 byte each         â•‘ Stores information about blocks falling status                                                        â•‘
â•‘ 0x0463          â•‘                     â•‘ (xxx2 -> xxx5 | l -> r column)                                                                        â•‘
â•‘ 0x0464          â•‘                     â•‘                                                                                                       â•‘
â•‘ 0x0465          â•‘                     â•‘ 0 - no block falling (ie moving, so set to 0 when block stops moving)                                 â•‘
â•‘                 â•‘                     â•‘ 1 - block in column, blocks are stunned (delay between setting prev blocks and dropping new ones)     â•‘
â•‘                 â•‘                     â•‘ 2 - block falling in column                                                                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ 0x0490 - 0x0497 â•‘ 1 byte each address â•‘ Stores the currently displayed blocks on the board                                                    â•‘
â•‘ 0x0499 - 0x04A0 â•‘                     â•‘ 0x0490 -> 0x0497 = top -> bottom                                                                      â•‘
â•‘ 0x04A2 - 0x04A9 â•‘                     â•‘ 0x0490 -> 0x04AB = left -> right                                                                      â•‘
â•‘ 0x04AB - 0x04B2 â•‘                     â•‘ Stores the positions from top to bottom, with a 1 byte buffer between each column.                    â•‘
â•‘                 â•‘                     â•‘ Positions only include set pieces (so NOT ones that have 2 for their respective above address)        â•‘
â•‘                 â•‘                     â•‘ Uses same values as falling block addresses                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


]]--

MemMap.addresses = {
    MARIO_POS = 0x0440,
    MARIO_FRAME = 0x0442,
    FALL_TYPES_START = 0x045A,
    FALL_STATUS_START = 0x0462,
    BOARD_START = 0x0490
}

function MemMap:marioPos()
    return memory.readbyte(MemMap.addresses.MARIO_POS)
end

function MemMap:marioFrame()
    return memory.readbyte(MemMap.addresses.MARIO_FRAME)
end

function MemMap:fallingBlocks()
    return readBytes(MemMap.addresses.FALL_TYPES_START, 4)
end

function MemMap:areBlocksFalling()
    return hasValue(readBytes(MemMap.addresses.FALL_STATUS_START, 4), 2)
end

--function MemMap:anyBlocksFalling

--END CLASS--

board = {
    --[[top   ->  bottom]] --
    { 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0 }
}

--gets the first block in a column (table) that is not empty, starting from the top
--TODO: change for loop to for each
--TODO: make all these functions just get the column themselves since i never do anything else
function getTopBlock(column)
    --[[for i = 1, 8 do
        if column[i] > 0 then
            return column[i]
        end
    end
    return 0]] --
    for _, v in ipairs(column) do
        if v > 0 then
            return v
        end
    end
    return 0
end

function doColumnsHaveMatch(block)
    return { getTopBlock(board[1]) == block, getTopBlock(board[2]) == block, getTopBlock(board[3]) == block, getTopBlock(board[4]) == block }
end

--gets the amount of blocks in a column (table) that are not empty
--TODO: change for loop to for each
function getColumnSize(column)
    for i = 1, 8 do
        if column[i] > 0 then
            return 9 - i
        end
    end
    return 0
end

function getColumn(columnNumber)
    local columnTable = {}
    for j = 1, 8 do
        columnTable[j] = memory.readbyte(0x0490 + (j - 1) + ((columnNumber - 1) * 9))
    end
    return columnTable
end

--stores every block in the 2d table "board"
--NOTE: 8 per row
--NOTE: 2 byte spacing, figure out what they do
--NOTE: reads properly, but doesn't reload sprites.
--NOTE: Reloads for matches!! ex can force any two blocks to match by rewriting ðŸ˜ˆ
--NOTE: 0490-0497 controls column 1 top-bottom
--NOTE: 0499-04A0 controls column 2
--NOTE: 04A2-04A9 controls column 3
--NOTE: 04AB-04B2 controls column 4
function readBoard()
    for i = 1, 4 do
        --[[for j = 1, 8 do
            board[i][j] = memory.readbyte(0x0490 + (j - 1) + ((i - 1) * 9))
        end]] --
        board[i] = getColumn(i)
    end
end